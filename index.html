<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adoirama</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Cinzel:wght@400;600&family=IM+Fell+English:ital@0;1&family=Courier+Prime:ital@0;1&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --void: #07080a; --deep: #0c0e12; --surface: #12151c;
  --border: rgba(180,140,80,0.2); --border-lit: rgba(180,140,80,0.55);
  --gold: #c8a84b; --gold-dim: #8a6e2a;
  --parchment: #e8dcc8; --aged: #b8a888; --muted: #6a6050;
  --rust: #8b3a2a; --rose: #7a3a5a; --moss: #3a5a3a;
  --glow-gold: rgba(200,168,75,0.12);
  --midnight: #0a0c10;
}
html, body { height: 100%; background: var(--void); color: var(--parchment); font-family: 'Courier Prime', monospace; }
body::after {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 9999; opacity: 0.3;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)' opacity='0.12'/%3E%3C/svg%3E");
}

/* â•â•â• SCREENS â•â•â• */
.screen { display: none; width: 100%; min-height: 100vh; }
.screen.active { display: block; }
#world-screen { display: none; }
#world-screen.active { display: grid; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* LANDING SCREEN */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#landing-screen {
  min-height: 100vh;
  display: none;
  align-items: center; justify-content: center; flex-direction: column;
  text-align: center;
  background: radial-gradient(ellipse at center, #0f1520 0%, var(--void) 70%);
}
#landing-screen.active { display: flex; }
.landing-ornament { font-size: 48px; margin-bottom: 24px; opacity: 0.7; animation: float 4s ease-in-out infinite; }
@keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
.landing-title { font-family: 'Cinzel Decorative', serif; font-size: clamp(28px,5vw,52px); color: var(--gold); letter-spacing: 4px; text-shadow: 0 0 60px rgba(200,168,75,0.4); margin-bottom: 10px; }
.landing-sub { font-family: 'IM Fell English', serif; font-size: 16px; font-style: italic; color: var(--muted); margin-bottom: 48px; max-width: 400px; line-height: 1.7; }
.landing-btns { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; }
.btn { padding: 13px 30px; font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 3px; text-transform: uppercase; cursor: pointer; transition: all 0.2s; border: 1px solid; background: none; }
.btn-gold { border-color: var(--gold); color: var(--gold); }
.btn-gold:hover { background: var(--glow-gold); box-shadow: 0 0 24px rgba(200,168,75,0.2); }
.btn-dim { border-color: var(--border); color: var(--muted); }
.btn-dim:hover { border-color: var(--gold-dim); color: var(--aged); }
.btn-danger { border-color: rgba(139,58,42,0.5); color: var(--rust); }
.btn-danger:hover { background: rgba(139,58,42,0.1); }
.landing-cast { margin-top: 40px; }
.cast-title { font-size: 9px; letter-spacing: 3px; color: var(--muted); text-transform: uppercase; margin-bottom: 12px; }
.cast-chips { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.cast-chip {
  padding: 5px 14px; border: 1px solid var(--border);
  font-size: 11px; color: var(--aged);
  cursor: pointer; transition: all 0.15s;
}
.cast-chip:hover { border-color: var(--gold-dim); color: var(--gold); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* CHARACTER CREATOR SCREEN */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#creator-screen { overflow-y: auto; }
.creator-wrap { max-width: 860px; margin: 0 auto; padding: 40px 20px 80px; }

/* Nav bar */
.creator-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 40px; }
.creator-nav-brand { font-family: 'Cinzel Decorative', serif; font-size: 14px; color: var(--gold); letter-spacing: 2px; cursor: pointer; }
.creator-nav-brand:hover { text-shadow: 0 0 20px rgba(200,168,75,0.4); }

.diorama-eyebrow { font-family: 'Courier Prime', monospace; font-size: 10px; letter-spacing: 5px; color: var(--gold-dim); text-transform: uppercase; margin-bottom: 10px; text-align: center; }
.diorama-title { font-family: 'Cinzel Decorative', serif; font-size: clamp(20px,4vw,32px); color: var(--gold); letter-spacing: 3px; text-shadow: 0 0 40px rgba(200,168,75,0.3); margin-bottom: 8px; text-align: center; }
.diorama-subtitle { font-family: 'IM Fell English', serif; font-size: 14px; font-style: italic; color: var(--muted); text-align: center; margin-bottom: 40px; }

.divider { display: flex; align-items: center; gap: 14px; margin: 28px 0; color: var(--gold-dim); }
.divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.divider-glyph { font-size: 11px; letter-spacing: 3px; white-space: nowrap; }

.section { margin-bottom: 32px; }
.section-head { margin-bottom: 18px; }
.section-label { display: flex; gap: 12px; align-items: baseline; }
.section-num { font-family: 'Cinzel', serif; font-size: 11px; color: var(--gold-dim); letter-spacing: 2px; }
.section-title { font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 3px; text-transform: uppercase; color: var(--gold); }
.section-hint { font-family: 'IM Fell English', serif; font-size: 12px; font-style: italic; color: var(--muted); margin-top: 3px; padding-left: 32px; }

.field { margin-bottom: 14px; }
.field-label { display: block; font-size: 9px; letter-spacing: 3px; text-transform: uppercase; color: var(--muted); margin-bottom: 7px; }
.field-input, .field-select, .field-textarea {
  width: 100%; background: rgba(200,168,75,0.03); border: 1px solid var(--border);
  color: var(--parchment); font-family: 'IM Fell English', serif; font-size: 15px;
  padding: 10px 14px; outline: none; transition: border 0.2s, background 0.2s; appearance: none;
}
.field-input::placeholder, .field-textarea::placeholder { color: var(--muted); font-style: italic; }
.field-input:focus, .field-select:focus, .field-textarea:focus { border-color: var(--border-lit); background: rgba(200,168,75,0.06); }
.field-textarea { resize: vertical; min-height: 80px; line-height: 1.6; }
.field-select { cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238a6e2a'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px; }
.field-select option { background: #12151c; }
.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.three-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
@media(max-width:560px){ .two-col,.three-col { grid-template-columns: 1fr; } }

.chip-grid { display: flex; flex-wrap: wrap; gap: 7px; }
.chip { padding: 5px 12px; border: 1px solid var(--border); font-family: 'Courier Prime', monospace; font-size: 10px; letter-spacing: 1px; color: var(--muted); cursor: pointer; transition: all 0.15s; user-select: none; }
.chip:hover { border-color: var(--gold-dim); color: var(--aged); }
.chip.on { border-color: var(--gold); color: var(--gold); background: var(--glow-gold); }
.chip.on::before { content: 'âœ“ '; font-size: 9px; }
.chip-limit-note { font-size: 10px; color: var(--muted); font-style: italic; margin-top: 8px; }

.archetype-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; }
@media(max-width:600px){ .archetype-grid { grid-template-columns: repeat(2,1fr); } }
.archetype-card { border: 1px solid var(--border); padding: 14px 10px; cursor: pointer; transition: all 0.2s; text-align: center; position: relative; background: rgba(200,168,75,0.02); }
.archetype-card:hover { border-color: var(--gold-dim); background: rgba(200,168,75,0.05); }
.archetype-card.on { border-color: var(--gold); background: var(--glow-gold); }
.arch-glyph { font-size: 24px; margin-bottom: 6px; display: block; }
.arch-name { font-family: 'Cinzel', serif; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--gold); display: block; margin-bottom: 4px; }
.arch-desc { font-family: 'IM Fell English', serif; font-size: 11px; font-style: italic; color: var(--muted); line-height: 1.4; }

.slider-row { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
.slider-label { font-size: 10px; letter-spacing: 1px; color: var(--muted); min-width: 120px; text-transform: uppercase; }
.slider-poles { display: flex; align-items: center; gap: 10px; flex: 1; }
.slider-pole { font-size: 10px; color: var(--muted); font-style: italic; min-width: 80px; }
.slider-pole:last-child { text-align: right; }
input[type=range] { flex: 1; height: 2px; appearance: none; background: var(--border); outline: none; cursor: pointer; }
input[type=range]::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; background: var(--gold); border-radius: 0; transform: rotate(45deg); box-shadow: 0 0 8px rgba(200,168,75,0.4); }

.rel-card { border: 1px solid var(--border); padding: 14px; margin-bottom: 10px; background: rgba(200,168,75,0.02); }
.rel-card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.rel-card-title { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 2px; color: var(--gold); text-transform: uppercase; }
.rel-remove { font-size: 10px; color: var(--rust); cursor: pointer; border: none; background: none; letter-spacing: 1px; padding: 2px 6px; }
.add-rel-btn { width: 100%; padding: 10px; border: 1px dashed var(--border); background: none; color: var(--muted); font-family: 'Courier Prime', monospace; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
.add-rel-btn:hover { border-color: var(--gold-dim); color: var(--gold); }

.secret-box { border: 1px solid rgba(139,58,42,0.3); background: rgba(139,58,42,0.05); padding: 16px; position: relative; }
.secret-box::before { content: 'âš  SEALED'; position: absolute; top: -9px; left: 16px; font-size: 9px; letter-spacing: 3px; color: var(--rust); background: var(--void); padding: 0 8px; }

.voice-sample { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
.voice-prompt { font-size: 10px; color: var(--muted); font-style: italic; min-width: 130px; }

#preview-wrap { margin-top: 40px; opacity: 0; transition: opacity 0.5s; }
#preview-wrap.visible { opacity: 1; }
.preview-card { border: 1px solid var(--border-lit); background: linear-gradient(135deg, rgba(200,168,75,0.06) 0%, transparent 60%); padding: 24px; position: relative; }
.preview-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--gold), transparent); }
.preview-header { display: flex; gap: 16px; align-items: flex-start; margin-bottom: 16px; }
.preview-glyph { font-size: 36px; opacity: 0.8; }
.preview-name { font-family: 'Cinzel Decorative', serif; font-size: 20px; color: var(--gold); letter-spacing: 2px; }
.preview-archetype { font-family: 'IM Fell English', serif; font-size: 13px; font-style: italic; color: var(--muted); margin-top: 3px; }
.preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin: 14px 0; }
.preview-field-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 4px; }
.preview-field-value { font-family: 'IM Fell English', serif; font-size: 13px; color: var(--aged); line-height: 1.5; }
.preview-traits { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 14px; }
.preview-trait { padding: 3px 9px; border: 1px solid var(--border-lit); font-size: 9px; letter-spacing: 1px; color: var(--gold); text-transform: uppercase; }
.preview-stat-row { display: flex; border: 1px solid var(--border); }
.preview-stat { flex: 1; text-align: center; padding: 10px 4px; border-right: 1px solid var(--border); }
.preview-stat:last-child { border-right: none; }
.preview-stat-val { font-family: 'Cinzel', serif; font-size: 16px; color: var(--gold); display: block; }
.preview-stat-lbl { font-size: 8px; letter-spacing: 1px; color: var(--muted); text-transform: uppercase; }

.action-bar { display: flex; gap: 12px; margin-top: 28px; justify-content: center; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* WORLD SCREEN */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#world-screen {
  grid-template-columns: 300px 1fr 270px;
  grid-template-rows: 56px 1fr 170px;
  height: 100vh;
  overflow: hidden;
}
header {
  grid-column: 1 / -1;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px;
  border-bottom: 1px solid var(--border);
  background: rgba(10,12,16,0.95);
  position: relative; z-index: 10;
}
.world-logo { font-family: 'Cinzel Decorative', serif; font-size: 16px; color: var(--gold); letter-spacing: 3px; cursor: pointer; }
.world-logo:hover { text-shadow: 0 0 20px rgba(200,168,75,0.5); }
.world-time { font-size: 11px; color: var(--aged); letter-spacing: 2px; }
.world-controls { display: flex; gap: 10px; align-items: center; }
.wbtn { padding: 6px 14px; border: 1px solid var(--border); background: transparent; color: var(--aged); font-family: 'Courier Prime', monospace; font-size: 11px; letter-spacing: 1px; cursor: pointer; transition: all 0.2s; }
.wbtn:hover { border-color: var(--gold-dim); color: var(--gold); }
.wbtn.active { background: var(--glow-gold); border-color: var(--gold); color: var(--gold); }

/* Left panel */
#roster-panel { grid-row: 2; border-right: 1px solid var(--border); overflow-y: auto; padding: 14px; background: rgba(10,12,16,0.7); }
.panel-title { font-family: 'Cinzel', serif; font-size: 9px; letter-spacing: 3px; text-transform: uppercase; color: var(--gold-dim); margin-bottom: 14px; }

.character-card { border: 1px solid var(--border); padding: 11px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; background: rgba(200,168,75,0.02); }
.character-card:hover, .character-card.selected { border-color: rgba(200,168,75,0.5); background: rgba(200,168,75,0.07); }
.char-header { display: flex; justify-content: space-between; align-items: baseline; }
.char-name { font-family: 'Cinzel', serif; font-size: 14px; color: var(--parchment); }
.char-status-badge { font-size: 9px; color: var(--aged); letter-spacing: 1px; }
.char-trait-row { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 5px; }
.trait-tag { font-size: 8px; padding: 2px 5px; border: 1px solid var(--border); color: var(--aged); }
.char-mood { margin-top: 6px; font-size: 10px; color: var(--muted); font-style: italic; }
.alive-dot { width: 6px; height: 6px; border-radius: 50%; background: #4a8c4a; display: inline-block; margin-right: 5px; box-shadow: 0 0 4px #4a8c4a; animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

#add-char-world-btn { width: 100%; padding: 9px; border: 1px dashed var(--border); background: none; color: var(--muted); font-family: 'Courier Prime', monospace; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; transition: all 0.2s; margin-top: 4px; }
#add-char-world-btn:hover { border-color: var(--gold-dim); color: var(--gold); }

/* World canvas */
#world-panel { grid-row: 2; position: relative; overflow: hidden; background: var(--midnight); }
#world-canvas { width: 100%; height: 100%; display: block; }

/* Right log */
#log-panel { grid-row: 2; border-left: 1px solid var(--border); overflow-y: auto; padding: 14px; background: rgba(10,12,16,0.7); }
#log-entries { display: flex; flex-direction: column; gap: 9px; }
.log-entry { font-size: 11px; line-height: 1.6; color: var(--aged); border-left: 2px solid rgba(200,168,75,0.2); padding-left: 10px; animation: fadeIn 0.4s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateX(6px)} to{opacity:1;transform:none} }
.log-time { color: var(--muted); font-size: 9px; display: block; margin-bottom: 2px; letter-spacing: 1px; }
.log-char { color: var(--gold); }
.log-entry.important { border-left-color: var(--rust); color: var(--parchment); }
.log-entry.romance { border-left-color: #8b4a6e; }
.log-entry.conflict { border-left-color: var(--rust); }

/* Bottom bar */
#bottom-bar { grid-column: 1 / -1; border-top: 1px solid var(--border); background: rgba(10,12,16,0.97); display: grid; grid-template-columns: 300px 1fr 270px; }
#selected-detail { padding: 12px 14px; border-right: 1px solid var(--border); overflow-y: auto; }
.detail-name { font-family: 'Cinzel', serif; font-size: 16px; color: var(--gold); margin-bottom: 6px; }
.stat-row { display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 4px; }
.stat { font-size: 10px; color: var(--muted); }
.stat-val { color: var(--parchment); }
#world-stats { padding: 12px 16px; display: flex; gap: 20px; align-items: center; justify-content: center; }
.world-stat { text-align: center; }
.world-stat-num { font-family: 'Cinzel Decorative', serif; font-size: 26px; color: var(--gold); display: block; }
.world-stat-lbl { font-size: 8px; letter-spacing: 2px; color: var(--muted); text-transform: uppercase; }
#nudge-panel { padding: 12px 14px; border-left: 1px solid var(--border); overflow-y: auto; }
.nudge-btn { display: block; width: 100%; text-align: left; padding: 5px 10px; margin-bottom: 4px; font-size: 10px; border: 1px solid var(--border); background: transparent; color: var(--aged); cursor: pointer; transition: all 0.2s; font-family: 'Courier Prime', monospace; }
.nudge-btn:hover { background: var(--glow-gold); color: var(--gold); border-color: rgba(200,168,75,0.4); }

::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(200,168,75,0.2); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- LANDING SCREEN -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="landing-screen" class="screen active">
  <div class="landing-ornament">â—ˆ</div>
  <div class="landing-title">Adoirama</div>
  <div class="landing-sub">A living world of souls you shape but cannot control.<br>Set them free and watch what happens.</div>
  <div class="landing-btns">
    <button class="btn btn-gold" onclick="goTo('creator')">âœ¦ Create a Character</button>
    <button class="btn btn-dim" onclick="goTo('world')">Enter the World</button>
  </div>
  <div class="landing-cast" id="landing-cast" style="display:none">
    <div class="cast-title">â€” Souls already in your world â€”</div>
    <div class="cast-chips" id="cast-chips"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- CHARACTER CREATOR SCREEN -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="creator-screen" class="screen">
<div class="creator-wrap">

  <div class="creator-nav">
    <span class="creator-nav-brand" onclick="goTo('landing')">â† Adoirama</span>
    <span style="font-size:10px;color:var(--muted);letter-spacing:2px">SOUL CREATION</span>
  </div>

  <div class="diorama-eyebrow">Adoirama</div>
  <div class="diorama-title">Breathe Life into a Soul</div>
  <div class="diorama-subtitle">Fill each vessel with care. What you write, they will become.</div>

  <!-- I. IDENTITY -->
  <div class="section">
    <div class="section-head">
      <div class="section-label"><span class="section-num">I.</span><span class="section-title">Identity</span></div>
      <div class="section-hint">The skin they wear in the world.</div>
    </div>
    <div class="two-col">
      <div class="field"><label class="field-label">Full Name</label><input class="field-input" id="c-name" placeholder="e.g. Edric Vane" oninput="updatePreview()"></div>
      <div class="field"><label class="field-label">Known As / Alias</label><input class="field-input" id="c-alias" placeholder="e.g. The Grey Wolf" oninput="updatePreview()"></div>
    </div>
    <div class="three-col">
      <div class="field"><label class="field-label">Age</label><input class="field-input" id="c-age" type="number" min="14" max="90" placeholder="32" oninput="updatePreview()"></div>
      <div class="field"><label class="field-label">Gender</label><input class="field-input" id="c-gender" placeholder="e.g. Woman" oninput="updatePreview()"></div>
      <div class="field"><label class="field-label">Origin</label><input class="field-input" id="c-origin" placeholder="e.g. The Coldshore" oninput="updatePreview()"></div>
    </div>
    <div class="field"><label class="field-label">Appearance</label><textarea class="field-textarea" id="c-appearance" placeholder="Tall and angular, ink-stained fingers, always in grey wool. Carries a knife she never draws." style="min-height:65px" oninput="updatePreview()"></textarea></div>
    <div class="field"><label class="field-label">Occupation / Role</label><input class="field-input" id="c-occupation" placeholder="e.g. Disgraced apothecary, part-time fence" oninput="updatePreview()"></div>
  </div>

  <div class="divider"><span class="divider-glyph">â¬§ â¬§ â¬§</span></div>

  <!-- II. ARCHETYPE -->
  <div class="section">
    <div class="section-head">
      <div class="section-label"><span class="section-num">II.</span><span class="section-title">Archetype</span></div>
      <div class="section-hint">The shape of their story.</div>
    </div>
    <div class="archetype-grid" id="archetype-grid"></div>
  </div>

  <div class="divider"><span class="divider-glyph">â¬§ â¬§ â¬§</span></div>

  <!-- III. PERSONALITY -->
  <div class="section">
    <div class="section-head">
      <div class="section-label"><span class="section-num">III.</span><span class="section-title">Personality</span></div>
      <div class="section-hint">How they move through the world.</div>
    </div>
    <div style="margin-bottom:20px">
      <label class="field-label" style="margin-bottom:10px;display:block">Core Traits â€” pick up to 6</label>
      <div class="chip-grid" id="trait-grid"></div>
      <div class="chip-limit-note" id="trait-note">0 / 6 selected</div>
    </div>
    <label class="field-label" style="margin-bottom:14px;display:block">Disposition Spectrum</label>
    <div class="slider-row"><div class="slider-label">Social</div><div class="slider-poles"><span class="slider-pole">Reclusive</span><input type="range" id="sl-social" min="0" max="100" value="50" oninput="updatePreview()"><span class="slider-pole">Gregarious</span></div></div>
    <div class="slider-row"><div class="slider-label">Moral Compass</div><div class="slider-poles"><span class="slider-pole">Self-serving</span><input type="range" id="sl-moral" min="0" max="100" value="50" oninput="updatePreview()"><span class="slider-pole">Selfless</span></div></div>
    <div class="slider-row"><div class="slider-label">Temperament</div><div class="slider-poles"><span class="slider-pole">Hot-headed</span><input type="range" id="sl-temper" min="0" max="100" value="50" oninput="updatePreview()"><span class="slider-pole">Stoic</span></div></div>
    <div class="slider-row"><div class="slider-label">Outlook</div><div class="slider-poles"><span class="slider-pole">Pessimist</span><input type="range" id="sl-outlook" min="0" max="100" value="55" oninput="updatePreview()"><span class="slider-pole">Optimist</span></div></div>
    <div class="slider-row"><div class="slider-label">Deception</div><div class="slider-poles"><span class="slider-pole">Brutally honest</span><input type="range" id="sl-deception" min="0" max="100" value="30" oninput="updatePreview()"><span class="slider-pole">Silver-tongued</span></div></div>
    <div class="field" style="margin-top:18px"><label class="field-label">Mannerisms & Habits</label><textarea class="field-textarea" id="c-mannerisms" placeholder="Taps her foot when nervous. Never apologises. Hums old hymns while working." oninput="updatePreview()"></textarea></div>
  </div>

  <div class="divider"><span class="divider-glyph">â¬§ â¬§ â¬§</span></div>

  <!-- IV. DRIVES & WOUNDS -->
  <div class="section">
    <div class="section-head">
      <div class="section-label"><span class="section-num">IV.</span><span class="section-title">Drives & Wounds</span></div>
      <div class="section-hint">What moves them. What broke them.</div>
    </div>
    <div class="two-col">
      <div class="field"><label class="field-label">Greatest Desire</label><textarea class="field-textarea" id="c-desire" placeholder="To be seen as more than what her family made her." style="min-height:75px" oninput="updatePreview()"></textarea></div>
      <div class="field"><label class="field-label">Deepest Fear</label><textarea class="field-textarea" id="c-fear" placeholder="That she is exactly what they say she is." style="min-height:75px" oninput="updatePreview()"></textarea></div>
    </div>
    <div class="two-col">
      <div class="field"><label class="field-label">Primary Goal</label><textarea class="field-textarea" id="c-goal" placeholder="Find the man who burned her village and make him answer for it." style="min-height:75px" oninput="updatePreview()"></textarea></div>
      <div class="field"><label class="field-label">The Wound â€” formative trauma</label><textarea class="field-textarea" id="c-wound" placeholder="She ran when her brother was taken. She has never told anyone." style="min-height:75px" oninput="updatePreview()"></textarea></div>
    </div>
    <div class="field"><label class="field-label">Moral Limit â€” the one line they will not cross</label><input class="field-input" id="c-limit" placeholder="e.g. She will not use a child as a tool, no matter the cause." oninput="updatePreview()"></div>
    <div class="field"><label class="field-label">The Lie They Believe About Themselves</label><input class="field-input" id="c-lie" placeholder="e.g. That she is beyond saving. That affection always comes with a cost." oninput="updatePreview()"></div>
  </div>

  <div class="divider"><span class="divider-glyph">â¬§ â¬§ â¬§</span></div>

  <!-- V. HISTORY -->
  <div class="section">
    <div class="section-head">
      <div class="section-label"><span class="section-num">V.</span><span class="section-title">History</span></div>
      <div class="section-hint">Where they've been. What they carry.</div>
    </div>
    <div class="field"><label class="field-label">Background</label><textarea class="field-textarea" id="c-background" style="min-height:100px" placeholder="Born third child to a merchant family. Apprenticed at thirteen to an apothecary who taught her as much about forgery as medicine. Fled north after the business went wrong." oninput="updatePreview()"></textarea></div>
    <div class="two-col">
      <div class="field"><label class="field-label">Greatest Achievement</label><input class="field-input" id="c-achievement" placeholder="e.g. Negotiated the release of nine hostages alone." oninput="updatePreview()"></div>
      <div class="field"><label class="field-label">Greatest Regret</label><input class="field-input" id="c-regret" placeholder="e.g. Testified against a friend who was innocent." oninput="updatePreview()"></div>
    </div>
    <div class="field"><label class="field-label">What do they own of value?</label><input class="field-input" id="c-possessions" placeholder="e.g. A locked journal, a broken pocket watch, seven gold coins sewn into her coat." oninput="updatePreview()"></div>
  </div>

  <div class="divider"><span class="divider-glyph">â¬§ â¬§ â¬§</span></div>

  <!-- VI. SKILLS -->
  <div class="section">
    <div class="section-head">
      <div class="section-label"><span class="section-num">VI.</span><span class="section-title">Skills & Attributes</span></div>
      <div class="section-hint">What they can do. Where they fall short.</div>
    </div>
    <div class="two-col" style="margin-bottom:16px">
      <div class="field"><label class="field-label">Notable Skills (one per line)</label><textarea class="field-textarea" id="c-skills" placeholder="Herbalism and poison-craft&#10;Forgery&#10;Lockpicking&#10;Persuasion through half-truths" oninput="updatePreview()"></textarea></div>
      <div class="field"><label class="field-label">Notable Weaknesses (one per line)</label><textarea class="field-textarea" id="c-weaknesses" placeholder="Terrible liar under pressure&#10;Cannot swim&#10;Pathological mistrust of authority" oninput="updatePreview()"></textarea></div>
    </div>
    <label class="field-label" style="margin-bottom:14px;display:block">Attribute Ratings</label>
    <div class="slider-row"><div class="slider-label">Strength</div><div class="slider-poles"><span class="slider-pole">Frail</span><input type="range" id="attr-str" min="1" max="10" value="5" oninput="updatePreview()"><span class="slider-pole">Formidable</span></div></div>
    <div class="slider-row"><div class="slider-label">Cunning</div><div class="slider-poles"><span class="slider-pole">Simple</span><input type="range" id="attr-int" min="1" max="10" value="5" oninput="updatePreview()"><span class="slider-pole">Brilliant</span></div></div>
    <div class="slider-row"><div class="slider-label">Charisma</div><div class="slider-poles"><span class="slider-pole">Off-putting</span><input type="range" id="attr-cha" min="1" max="10" value="5" oninput="updatePreview()"><span class="slider-pole">Magnetic</span></div></div>
    <div class="slider-row"><div class="slider-label">Resilience</div><div class="slider-poles"><span class="slider-pole">Fragile</span><input type="range" id="attr-res" min="1" max="10" value="5" oninput="updatePreview()"><span class="slider-pole">Unbreakable</span></div></div>
    <div class="slider-row"><div class="slider-label">Luck</div><div class="slider-poles"><span class="slider-pole">Cursed</span><input type="range" id="attr-lck" min="1" max="10" value="5" oninput="updatePreview()"><span class="slider-pole">Charmed</span></div></div>
  </div>

  <div class="divider"><span class="divider-glyph">â¬§ â¬§ â¬§</span></div>

  <!-- VII. RELATIONSHIPS -->
  <div class="section">
    <div class="section-head">
      <div class="section-label"><span class="section-num">VII.</span><span class="section-title">Relationships</span></div>
      <div class="section-hint">The threads that bind and fray.</div>
    </div>
    <div id="relationships-list"></div>
    <button class="add-rel-btn" onclick="addRelationship()">+ Add a Connection</button>
  </div>

  <div class="divider"><span class="divider-glyph">â¬§ â¬§ â¬§</span></div>

  <!-- VIII. BELIEFS -->
  <div class="section">
    <div class="section-head">
      <div class="section-label"><span class="section-num">VIII.</span><span class="section-title">Beliefs & Worldview</span></div>
      <div class="section-hint">What they hold to be true. What they will die defending.</div>
    </div>
    <div class="field">
      <label class="field-label">Religion / Spirituality</label>
      <div class="chip-grid" style="margin-bottom:10px" id="religion-chips">
        <div class="chip" data-group="religion" onclick="toggleTag(this,'religion')">Devout</div>
        <div class="chip" data-group="religion" onclick="toggleTag(this,'religion')">Lapsed faith</div>
        <div class="chip" data-group="religion" onclick="toggleTag(this,'religion')">Spiritual</div>
        <div class="chip" data-group="religion" onclick="toggleTag(this,'religion')">Agnostic</div>
        <div class="chip" data-group="religion" onclick="toggleTag(this,'religion')">Atheist</div>
        <div class="chip" data-group="religion" onclick="toggleTag(this,'religion')">Superstitious</div>
      </div>
      <input class="field-input" id="c-religion-detail" placeholder="Which faith? Personal rites? Doubts?" oninput="updatePreview()">
    </div>
    <div class="field">
      <label class="field-label">Political Alignment</label>
      <div class="chip-grid" id="politics-chips">
        <div class="chip" data-group="politics" onclick="toggleTag(this,'politics')">Loyalist</div>
        <div class="chip" data-group="politics" onclick="toggleTag(this,'politics')">Rebel</div>
        <div class="chip" data-group="politics" onclick="toggleTag(this,'politics')">Neutral</div>
        <div class="chip" data-group="politics" onclick="toggleTag(this,'politics')">Opportunist</div>
        <div class="chip" data-group="politics" onclick="toggleTag(this,'politics')">Anarchist</div>
        <div class="chip" data-group="politics" onclick="toggleTag(this,'politics')">Idealist</div>
        <div class="chip" data-group="politics" onclick="toggleTag(this,'politics')">Pragmatist</div>
      </div>
    </div>
    <div class="field"><label class="field-label">Core Beliefs</label><textarea class="field-textarea" id="c-beliefs" placeholder="Family comes before everything, even justice. The powerful will always abuse the powerless." oninput="updatePreview()"></textarea></div>
    <div class="field"><label class="field-label">Prejudices & Blind Spots</label><textarea class="field-textarea" id="c-prejudices" placeholder="Distrusts anyone who speaks too smoothly." oninput="updatePreview()"></textarea></div>
  </div>

  <div class="divider"><span class="divider-glyph">â¬§ â¬§ â¬§</span></div>

  <!-- IX. VOICE -->
  <div class="section">
    <div class="section-head">
      <div class="section-label"><span class="section-num">IX.</span><span class="section-title">Voice</span></div>
      <div class="section-hint">How they speak. What they would say.</div>
    </div>
    <div class="chip-grid" style="margin-bottom:16px">
      <div class="chip" data-group="voice" onclick="toggleTag(this,'voice')">Terse</div>
      <div class="chip" data-group="voice" onclick="toggleTag(this,'voice')">Verbose</div>
      <div class="chip" data-group="voice" onclick="toggleTag(this,'voice')">Poetic</div>
      <div class="chip" data-group="voice" onclick="toggleTag(this,'voice')">Blunt</div>
      <div class="chip" data-group="voice" onclick="toggleTag(this,'voice')">Sardonic</div>
      <div class="chip" data-group="voice" onclick="toggleTag(this,'voice')">Warm</div>
      <div class="chip" data-group="voice" onclick="toggleTag(this,'voice')">Formal</div>
      <div class="chip" data-group="voice" onclick="toggleTag(this,'voice')">Guarded</div>
      <div class="chip" data-group="voice" onclick="toggleTag(this,'voice')">Crude</div>
    </div>
    <div class="voice-sample"><div class="voice-prompt">When angry:</div><input class="field-input" id="c-voice-angry" placeholder='"Keep pushing and see what happens."' style="flex:1"></div>
    <div class="voice-sample"><div class="voice-prompt">When afraid:</div><input class="field-input" id="c-voice-afraid" placeholder='"I\'m fine. Leave it."' style="flex:1"></div>
    <div class="voice-sample"><div class="voice-prompt">When they care:</div><input class="field-input" id="c-voice-care" placeholder='"You don\'t have to say anything. I\'m here."' style="flex:1"></div>
    <div class="voice-sample"><div class="voice-prompt">Habitual phrase:</div><input class="field-input" id="c-voice-habit" placeholder='"Well. That\'s that, then."' style="flex:1"></div>
  </div>

  <div class="divider"><span class="divider-glyph">â¬§ â¬§ â¬§</span></div>

  <!-- X. SECRET -->
  <div class="section">
    <div class="section-head">
      <div class="section-label"><span class="section-num">X.</span><span class="section-title">The Sealed Truth</span></div>
      <div class="section-hint">What no one in the world knows. Only you, the god, will see this.</div>
    </div>
    <div class="secret-box">
      <div class="field" style="margin-bottom:12px"><label class="field-label">The Secret They Carry</label><textarea class="field-textarea" id="c-secret" style="min-height:75px;border-color:rgba(139,58,42,0.3)" placeholder="She did not lose her brother to raiders. She watched him drown and told no one." oninput="updatePreview()"></textarea></div>
      <div class="field" style="margin-bottom:0"><label class="field-label">What would it cost if it came to light?</label><input class="field-input" id="c-secret-cost" style="border-color:rgba(139,58,42,0.3)" placeholder="Everything. Her reputation, her alliances, her sense of self." oninput="updatePreview()"></div>
    </div>
  </div>

  <div class="divider"><span class="divider-glyph">â¬§ â¬§ â¬§</span></div>

  <!-- XI. ENDINGS -->
  <div class="section">
    <div class="section-head">
      <div class="section-label"><span class="section-num">XI.</span><span class="section-title">Fate</span></div>
      <div class="section-hint">How their story might end.</div>
    </div>
    <div class="field"><label class="field-label">If fate is unkind</label><input class="field-input" id="c-dark-end" placeholder="e.g. Alone, having driven away everyone who ever loved her." oninput="updatePreview()"></div>
    <div class="field"><label class="field-label">If they find their way</label><input class="field-input" id="c-good-end" placeholder="e.g. Reconciled with her past; teaching others what she learned." oninput="updatePreview()"></div>
    <div class="field"><label class="field-label">Anything else the simulation should know</label><textarea class="field-textarea" id="c-notes" placeholder="She secretly writes poetry. She is terrified of enclosed spaces. Lactose intolerant and very cranky about it." oninput="updatePreview()"></textarea></div>
  </div>

  <!-- PREVIEW -->
  <div id="preview-wrap">
    <div class="divider"><span class="divider-glyph">â—ˆ Character Dossier â—ˆ</span></div>
    <div class="preview-card">
      <div class="preview-header">
        <div class="preview-glyph" id="prev-glyph">â—ˆ</div>
        <div><div class="preview-name" id="prev-name">â€”</div><div class="preview-archetype" id="prev-archetype">Unknown soul</div></div>
      </div>
      <div class="preview-traits" id="prev-traits"></div>
      <div class="preview-grid">
        <div><div class="preview-field-label">Desire</div><div class="preview-field-value" id="prev-desire">â€”</div></div>
        <div><div class="preview-field-label">Fear</div><div class="preview-field-value" id="prev-fear">â€”</div></div>
        <div><div class="preview-field-label">Goal</div><div class="preview-field-value" id="prev-goal">â€”</div></div>
        <div><div class="preview-field-label">Wound</div><div class="preview-field-value" id="prev-wound">â€”</div></div>
      </div>
      <div class="preview-stat-row">
        <div class="preview-stat"><span class="preview-stat-val" id="prev-str">5</span><span class="preview-stat-lbl">Strength</span></div>
        <div class="preview-stat"><span class="preview-stat-val" id="prev-int">5</span><span class="preview-stat-lbl">Cunning</span></div>
        <div class="preview-stat"><span class="preview-stat-val" id="prev-cha">5</span><span class="preview-stat-lbl">Charisma</span></div>
        <div class="preview-stat"><span class="preview-stat-val" id="prev-res">5</span><span class="preview-stat-lbl">Resilience</span></div>
        <div class="preview-stat"><span class="preview-stat-val" id="prev-lck">5</span><span class="preview-stat-lbl">Luck</span></div>
      </div>
    </div>
  </div>

  <div class="action-bar">
    <button class="btn btn-dim" onclick="resetCreatorForm()">Clear All</button>
    <button class="btn btn-gold" onclick="summonSoul()">âœ¦ Summon this Soul into the World</button>
  </div>

</div><!-- /creator-wrap -->
</div><!-- /creator-screen -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- WORLD SCREEN -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="world-screen">
  <header>
    <div class="world-logo" onclick="goTo('landing')">â—ˆ Adoirama</div>
    <div class="world-time" id="world-time">Day 1 â€” Dawn</div>
    <div class="world-controls">
      <button class="wbtn" id="speed-btn" onclick="cycleSpeed()">Speed Ã—1</button>
      <button class="wbtn" id="run-btn" onclick="toggleRun()">â–¶ Run</button>
      <button class="wbtn" onclick="goTo('creator')">+ New Soul</button>
    </div>
  </header>

  <div id="roster-panel">
    <div class="panel-title">â€” Souls in the World â€”</div>
    <div id="character-list"></div>
    <button id="add-char-world-btn" onclick="goTo('creator')">+ Create a Character</button>
  </div>

  <div id="world-panel"><canvas id="world-canvas"></canvas></div>

  <div id="log-panel">
    <div class="panel-title">â€” Chronicle â€”</div>
    <div id="log-entries"></div>
  </div>

  <div id="bottom-bar">
    <div id="selected-detail"><div style="color:var(--muted);font-size:11px;font-style:italic;margin-top:18px;">Select a soul to inspect them.</div></div>
    <div id="world-stats">
      <div class="world-stat"><span class="world-stat-num" id="stat-pop">0</span><span class="world-stat-lbl">Souls</span></div>
      <div class="world-stat"><span class="world-stat-num" id="stat-day">1</span><span class="world-stat-lbl">Day</span></div>
      <div class="world-stat"><span class="world-stat-num" id="stat-events">0</span><span class="world-stat-lbl">Events</span></div>
      <div class="world-stat"><span class="world-stat-num" id="stat-bonds">0</span><span class="world-stat-lbl">Bonds</span></div>
    </div>
    <div id="nudge-panel">
      <div class="panel-title" style="margin-bottom:8px">â€” Nudge the World â€”</div>
      <button class="nudge-btn" onclick="nudge('rumour')">ğŸ“œ Spread a rumour</button>
      <button class="nudge-btn" onclick="nudge('storm')">â›ˆ Send a storm</button>
      <button class="nudge-btn" onclick="nudge('stranger')">ğŸš¶ A stranger arrives</button>
      <button class="nudge-btn" onclick="nudge('feast')">ğŸ– Call a feast</button>
      <button class="nudge-btn" onclick="nudge('plague')">ğŸ’€ Release a plague</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTo(screen) {
  document.querySelectorAll('.screen, #world-screen, #landing-screen').forEach(s => s.classList.remove('active'));
  if (screen === 'world') {
    document.getElementById('world-screen').classList.add('active');
    initWorldIfNeeded();
    drawWorld();
  } else if (screen === 'creator') {
    document.getElementById('creator-screen').classList.add('active');
  } else {
    document.getElementById('landing-screen').classList.add('active');
    refreshLandingCast();
  }
  window.scrollTo(0, 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA STORE  (in-memory, persists for session)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORE = {
  characters: [],
  day: 1, hour: 6, tick: 0,
  totalEvents: 0, totalBonds: 0,
  running: false, speed: 1,
  selectedId: null,
  worldInitialised: false,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARCHETYPES & TRAITS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ARCHETYPES = [
  {id:'wanderer', glyph:'ğŸœ‚', name:'The Wanderer', desc:'Never stays; always searching'},
  {id:'sage',     glyph:'ğŸœ„', name:'The Sage',    desc:'Keeper of knowledge and quiet power'},
  {id:'trickster',glyph:'â˜¿',  name:'The Trickster',desc:'Agent of chaos, laughter, and change'},
  {id:'guardian', glyph:'ğŸœƒ', name:'The Guardian', desc:'Protector of those they love'},
  {id:'rebel',    glyph:'â™‚',  name:'The Rebel',    desc:'Fights the order of things'},
  {id:'lover',    glyph:'â™€',  name:'The Lover',    desc:'Driven by heart above all else'},
  {id:'ruler',    glyph:'â˜‰',  name:'The Ruler',    desc:'Born to lead â€” or thinks so'},
  {id:'outcast',  glyph:'â˜½',  name:'The Outcast',  desc:'Marked as different; walks alone'},
];
const ARCHETYPE_MAP = {};
ARCHETYPES.forEach(a => ARCHETYPE_MAP[a.id] = a);

const ALL_TRAITS = ['Ambitious','Kind','Vengeful','Curious','Brave','Secretive','Loyal','Jealous','Wise','Reckless','Charming','Melancholic','Proud','Cynical','Optimistic','Cunning','Empathetic','Cold','Playful','Cautious','Obsessive','Generous','Suspicious','Passionate','Humble','Arrogant','Patient','Volatile','Honest','Deceitful'];
const MOODS = ['thoughtful','restless','content','anxious','hopeful','bitter','wistful','determined','lonely','elated','guarded','serene'];

let selectedArchetype = null;
let selectedTraits = [];
const tagSelections = {};

function renderArchetypes() {
  const grid = document.getElementById('archetype-grid');
  if (!grid || grid.children.length) return;
  ARCHETYPES.forEach(a => {
    const div = document.createElement('div');
    div.className = 'archetype-card';
    div.dataset.id = a.id;
    div.innerHTML = `<span class="arch-glyph">${a.glyph}</span><span class="arch-name">${a.name}</span><span class="arch-desc">${a.desc}</span>`;
    div.onclick = () => {
      document.querySelectorAll('.archetype-card').forEach(c => c.classList.remove('on'));
      div.classList.add('on');
      selectedArchetype = a;
      updatePreview();
    };
    grid.appendChild(div);
  });
}

function renderTraitGrid() {
  const grid = document.getElementById('trait-grid');
  if (!grid || grid.children.length) return;
  ALL_TRAITS.forEach(t => {
    const div = document.createElement('div');
    div.className = 'chip';
    div.textContent = t;
    div.onclick = () => {
      if (div.classList.contains('on')) {
        div.classList.remove('on');
        selectedTraits = selectedTraits.filter(x => x !== t);
      } else if (selectedTraits.length < 6) {
        div.classList.add('on');
        selectedTraits.push(t);
      }
      document.getElementById('trait-note').textContent = `${selectedTraits.length} / 6 selected`;
      updatePreview();
    };
    grid.appendChild(div);
  });
}

function toggleTag(el, group) {
  document.querySelectorAll(`[data-group="${group}"]`).forEach(e => e.classList.remove('on'));
  el.classList.add('on');
  tagSelections[group] = el.textContent;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RELATIONSHIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let relCount = 0;
function addRelationship() {
  relCount++;
  const id = relCount;
  const list = document.getElementById('relationships-list');
  const card = document.createElement('div');
  card.className = 'rel-card';
  card.id = `rel-${id}`;
  card.innerHTML = `
    <div class="rel-card-head">
      <div class="rel-card-title">Connection ${id}</div>
      <button class="rel-remove" onclick="document.getElementById('rel-${id}').remove()">âœ• Remove</button>
    </div>
    <div class="two-col" style="margin-bottom:10px">
      <div class="field" style="margin:0"><label class="field-label">Their Name</label><input class="field-input" id="rel-name-${id}" placeholder="e.g. Brennan Holt"></div>
      <div class="field" style="margin:0"><label class="field-label">Relationship Type</label>
        <select class="field-select" id="rel-type-${id}">
          <option>Old friend</option><option>Estranged family</option><option>Mentor</option>
          <option>Rival</option><option>Enemy</option><option>Lost love</option>
          <option>Debt owed</option><option>Debt owed to them</option><option>Complicated</option>
        </select>
      </div>
    </div>
    <div class="field" style="margin-bottom:8px"><label class="field-label">What do they mean to this character?</label><textarea class="field-textarea" id="rel-meaning-${id}" style="min-height:55px" placeholder="The only person who ever told her the truth about herself."></textarea></div>
    <div class="field" style="margin:0"><label class="field-label">Current Status</label><input class="field-input" id="rel-status-${id}" placeholder="e.g. Missing; last seen heading north."></div>
  `;
  list.appendChild(card);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE PREVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function val(id) { const el = document.getElementById(id); return el ? el.value.trim() : ''; }
function updatePreview() {
  const name = val('c-name');
  const wrap = document.getElementById('preview-wrap');
  if (name) wrap.classList.add('visible');
  document.getElementById('prev-name').textContent = name || 'â€”';
  document.getElementById('prev-glyph').textContent = selectedArchetype?.glyph || 'â—ˆ';
  document.getElementById('prev-archetype').textContent = selectedArchetype
    ? `${selectedArchetype.name} Â· ${val('c-occupation') || val('c-origin') || 'Unknown origin'}`
    : (val('c-occupation') || 'Unknown soul');
  document.getElementById('prev-traits').innerHTML = selectedTraits.map(t => `<div class="preview-trait">${t}</div>`).join('');
  document.getElementById('prev-desire').textContent = val('c-desire') || 'â€”';
  document.getElementById('prev-fear').textContent = val('c-fear') || 'â€”';
  document.getElementById('prev-goal').textContent = val('c-goal') || 'â€”';
  document.getElementById('prev-wound').textContent = val('c-wound') || 'â€”';
  ['str','int','cha','res','lck'].forEach(s => {
    document.getElementById(`prev-${s}`).textContent = val(`attr-${s}`) || '5';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUMMON SOUL â†’ places into world
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function collectCharacterData() {
  const rels = [];
  for (let i = 1; i <= relCount; i++) {
    const el = document.getElementById(`rel-${i}`);
    if (!el) continue;
    rels.push({ name: val(`rel-name-${i}`), type: document.getElementById(`rel-type-${i}`)?.value, meaning: val(`rel-meaning-${i}`), status: val(`rel-status-${i}`) });
  }
  return {
    name: val('c-name'), alias: val('c-alias'), age: val('c-age'),
    gender: val('c-gender'), origin: val('c-origin'),
    appearance: val('c-appearance'), occupation: val('c-occupation'),
    archetype: selectedArchetype?.id || 'wanderer',
    archetypeName: selectedArchetype?.name || 'The Wanderer',
    archetypeGlyph: selectedArchetype?.glyph || 'â—ˆ',
    traits: [...selectedTraits],
    social: parseInt(val('sl-social'))||50, moral: parseInt(val('sl-moral'))||50,
    temper: parseInt(val('sl-temper'))||50, outlook: parseInt(val('sl-outlook'))||50,
    deception: parseInt(val('sl-deception'))||30,
    mannerisms: val('c-mannerisms'),
    desire: val('c-desire'), fear: val('c-fear'),
    goal: val('c-goal'), wound: val('c-wound'),
    limit: val('c-limit'), lie: val('c-lie'),
    background: val('c-background'), achievement: val('c-achievement'),
    regret: val('c-regret'), possessions: val('c-possessions'),
    skills: val('c-skills'), weaknesses: val('c-weaknesses'),
    str: parseInt(val('attr-str'))||5, int: parseInt(val('attr-int'))||5,
    cha: parseInt(val('attr-cha'))||5, res: parseInt(val('attr-res'))||5,
    lck: parseInt(val('attr-lck'))||5,
    relationships: rels,
    religion: tagSelections['religion'], religionDetail: val('c-religion-detail'),
    politics: tagSelections['politics'],
    beliefs: val('c-beliefs'), prejudices: val('c-prejudices'),
    voiceStyle: tagSelections['voice'],
    voiceAngry: val('c-voice-angry'), voiceAfraid: val('c-voice-afraid'),
    voiceCare: val('c-voice-care'), voiceHabit: val('c-voice-habit'),
    secret: val('c-secret'), secretCost: val('c-secret-cost'),
    darkEnd: val('c-dark-end'), goodEnd: val('c-good-end'),
    notes: val('c-notes'),
  };
}

function summonSoul() {
  const data = collectCharacterData();
  if (!data.name) { alert('Give your soul a name before sending them into the world.'); return; }

  const worldChar = makeWorldChar(data);
  STORE.characters.push(worldChar);
  STORE.totalEvents++;

  resetCreatorForm();
  goTo('world');

  setTimeout(() => {
    addLog(`<span class="log-char">${worldChar.name}</span>${worldChar.alias ? ` (${worldChar.alias})` : ''}, ${ARCHETYPE_MAP[worldChar.archetype]?.desc || 'a new soul'}, arrived at the settlement.`, 'important');
    updateWorldUI();
  }, 100);
}

function resetCreatorForm() {
  document.querySelectorAll('#creator-screen .field-input, #creator-screen .field-textarea').forEach(el => el.value = '');
  document.querySelectorAll('#creator-screen .chip.on, #creator-screen .archetype-card.on').forEach(el => el.classList.remove('on'));
  selectedTraits = []; selectedArchetype = null;
  Object.keys(tagSelections).forEach(k => delete tagSelections[k]);
  document.getElementById('trait-note').textContent = '0 / 6 selected';
  document.getElementById('relationships-list').innerHTML = '';
  relCount = 0;
  document.querySelectorAll('#creator-screen input[type=range]').forEach(el => el.value = el.id.startsWith('attr') ? 5 : 50);
  document.getElementById('preview-wrap').classList.remove('visible');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORLD CHARACTER FACTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let charIdCounter = 100;
const LOCATIONS = [
  {name:'The Tavern', x:0.22, y:0.48, icon:'ğŸš', radius:28},
  {name:'The Market', x:0.5,  y:0.28, icon:'âš–',  radius:24},
  {name:'The Forest', x:0.76, y:0.62, icon:'ğŸŒ²', radius:34},
  {name:'The Well',   x:0.5,  y:0.58, icon:'â—',  radius:20},
  {name:'The Keep',   x:0.72, y:0.24, icon:'âš”',  radius:27},
  {name:'The Church', x:0.28, y:0.72, icon:'â€ ',   radius:22},
  {name:'The Docks',  x:0.14, y:0.64, icon:'âš“',  radius:24},
];

function makeWorldChar(data) {
  const loc = Math.floor(Math.random() * LOCATIONS.length);
  return {
    id: ++charIdCounter,
    name: data.name, alias: data.alias || '',
    age: parseInt(data.age) || (18 + Math.floor(Math.random()*25)),
    gender: data.gender, origin: data.origin, occupation: data.occupation,
    appearance: data.appearance,
    archetype: data.archetype, archetypeGlyph: data.archetypeGlyph,
    traits: data.traits.length ? data.traits : [pick(ALL_TRAITS), pick(ALL_TRAITS)],
    social: data.social, moral: data.moral, temper: data.temper,
    outlook: data.outlook, deception: data.deception,
    desire: data.desire, fear: data.fear, goal: data.goal, wound: data.wound,
    limit: data.limit, lie: data.lie,
    background: data.background,
    str: data.str, int: data.int, cha: data.cha, res: data.res, lck: data.lck,
    relationships: data.relationships || [],
    secret: data.secret, secretCost: data.secretCost,
    voiceAngry: data.voiceAngry, voiceAfraid: data.voiceAfraid,
    voiceCare: data.voiceCare, voiceHabit: data.voiceHabit,
    darkEnd: data.darkEnd, goodEnd: data.goodEnd,
    // World state
    location: loc,
    wx: (Math.random()-0.5)*36, wy: (Math.random()-0.5)*36,
    mood: pick(MOODS),
    bonds: [], rivals: [],
    energy: 60 + Math.random()*40,
    reputation: 40 + Math.random()*30,
    history: [],
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS WORLD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('world-canvas');
const ctx = canvas.getContext('2d');
function resizeCanvas() {
  const panel = document.getElementById('world-panel');
  if (!panel) return;
  canvas.width = panel.offsetWidth;
  canvas.height = panel.offsetHeight;
}
window.addEventListener('resize', () => { resizeCanvas(); drawWorld(); });

function drawWorld() {
  if (!canvas.width || !canvas.height) { resizeCanvas(); }
  if (!canvas.width) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // BG
  const g = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width*0.7);
  g.addColorStop(0, '#111820'); g.addColorStop(1, '#060810');
  ctx.fillStyle = g; ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Grid
  ctx.strokeStyle = 'rgba(200,168,75,0.04)'; ctx.lineWidth = 1;
  for(let x=0;x<canvas.width;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();}
  for(let y=0;y<canvas.height;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}

  // Paths
  ctx.strokeStyle='rgba(200,168,75,0.07)';ctx.lineWidth=1;ctx.setLineDash([4,10]);
  [[0,3],[1,3],[1,4],[2,4],[3,5],[5,6],[0,6]].forEach(([a,b])=>{
    const la=LOCATIONS[a],lb=LOCATIONS[b];
    ctx.beginPath();ctx.moveTo(la.x*canvas.width,la.y*canvas.height);ctx.lineTo(lb.x*canvas.width,lb.y*canvas.height);ctx.stroke();
  });
  ctx.setLineDash([]);

  // Locations
  LOCATIONS.forEach(loc => {
    const x=loc.x*canvas.width, y=loc.y*canvas.height;
    const gr=ctx.createRadialGradient(x,y,0,x,y,loc.radius*2.5);
    gr.addColorStop(0,'rgba(200,168,75,0.07)');gr.addColorStop(1,'transparent');
    ctx.fillStyle=gr;ctx.beginPath();ctx.arc(x,y,loc.radius*2.5,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(200,168,75,0.22)';ctx.lineWidth=1;
    ctx.beginPath();ctx.arc(x,y,loc.radius,0,Math.PI*2);ctx.stroke();
    ctx.font='13px serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillStyle='rgba(200,168,75,0.55)';ctx.fillText(loc.icon,x,y);
    ctx.font='8px "Courier Prime",monospace';ctx.fillStyle='rgba(200,168,75,0.3)';
    ctx.fillText(loc.name.toUpperCase(),x,y+loc.radius+11);
  });

  // Bond lines
  STORE.characters.forEach(c=>{
    (c.bonds||[]).forEach(bId=>{
      const other=STORE.characters.find(x=>x.id===bId);
      if(other&&c.id<bId){
        const l1=LOCATIONS[c.location],l2=LOCATIONS[other.location];
        if(l1&&l2){
          ctx.strokeStyle='rgba(120,60,90,0.35)';ctx.lineWidth=1;
          ctx.setLineDash([2,8]);
          ctx.beginPath();
          ctx.moveTo(l1.x*canvas.width+c.wx,l1.y*canvas.height+c.wy);
          ctx.lineTo(l2.x*canvas.width+other.wx,l2.y*canvas.height+other.wy);
          ctx.stroke();ctx.setLineDash([]);
        }
      }
    });
  });

  // Characters
  STORE.characters.forEach(char=>{
    const loc=LOCATIONS[char.location];if(!loc)return;
    const x=loc.x*canvas.width+char.wx, y=loc.y*canvas.height+char.wy;
    const archColor = getArchColor(char.archetype);
    const isSel=STORE.selectedId===char.id;
    if(isSel){
      ctx.strokeStyle='rgba(200,168,75,0.9)';ctx.lineWidth=1.5;
      ctx.beginPath();ctx.arc(x,y,12,0,Math.PI*2);ctx.stroke();
    }
    ctx.fillStyle=archColor;ctx.shadowColor=archColor;ctx.shadowBlur=10;
    ctx.beginPath();ctx.arc(x,y,5,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    ctx.font='8px "Courier Prime",monospace';ctx.textAlign='center';ctx.textBaseline='top';
    ctx.fillStyle=isSel?'#e8c87a':'rgba(200,168,75,0.45)';
    ctx.fillText(char.name.split(' ')[0],x,y+8);
  });
}

function getArchColor(arch) {
  const cols={wanderer:'#7a9e7a',sage:'#7a7a9e',trickster:'#c9952a',guardian:'#5a8c9e',rebel:'#8b3a2a',lover:'#8b4a6e',ruler:'#9e8a2a',outcast:'#6a6a6a'};
  return cols[arch]||'#c8a84b';
}

canvas.addEventListener('click',(e)=>{
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  let clicked=null;
  STORE.characters.forEach(char=>{
    const loc=LOCATIONS[char.location];if(!loc)return;
    const x=loc.x*canvas.width+char.wx,y=loc.y*canvas.height+char.wy;
    if(Math.hypot(mx-x,my-y)<14)clicked=char;
  });
  if(clicked){STORE.selectedId=clicked.id;showCharDetail(clicked);}
  else{STORE.selectedId=null;document.getElementById('selected-detail').innerHTML='<div style="color:var(--muted);font-size:11px;font-style:italic;margin-top:18px;">Select a soul to inspect them.</div>';}
  renderRoster();drawWorld();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIMULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const HOUR_NAMES=['Deep Night','Deep Night','Deep Night','Deep Night','Deep Night','Dawn','Dawn','Morning','Morning','Morning','Morning','Midday','Midday','Afternoon','Afternoon','Afternoon','Dusk','Dusk','Night','Night','Night','Night','Night','Night'];
function hourLabel(h){return HOUR_NAMES[h]||'Night';}

const ACTION_POOL = {
  wander(c){
    const newLoc=Math.floor(Math.random()*LOCATIONS.length);
    const old=LOCATIONS[c.location].name;
    c.location=newLoc;c.wx=(Math.random()-0.5)*36;c.wy=(Math.random()-0.5)*36;
    return {text:`<span class="log-char">${c.name}</span> left ${old} and moved to ${LOCATIONS[newLoc].name}.`,type:'normal'};
  },
  rest(c){
    c.energy=Math.min(100,c.energy+18);
    const feelings=['restless','contemplative','at peace','listless','grateful'];
    return {text:`<span class="log-char">${c.name}</span> rested â€” feeling ${pick(feelings)}.`,type:'normal'};
  },
  seek_bond(c,store){
    const others=store.characters.filter(o=>o.id!==c.id&&o.location===c.location&&!c.bonds.includes(o.id)&&!c.rivals.includes(o.id));
    if(!others.length)return null;
    const other=pick(others);
    const compatible=c.traits.some(t=>other.traits.includes(t))||c.social>60||other.social>60;
    if(compatible||Math.random()<0.25){
      c.bonds.push(other.id);other.bonds.push(c.id);store.totalBonds++;
      const bonds=['found a quiet kinship with','formed an unexpected bond with','opened up to','shared something true with'];
      return {text:`<span class="log-char">${c.name}</span> ${pick(bonds)} <span class="log-char">${other.name}</span> at ${LOCATIONS[c.location].name}.`,type:'romance'};
    }
    return {text:`<span class="log-char">${c.name}</span> spoke with <span class="log-char">${other.name}</span> but little was said.`,type:'normal'};
  },
  conflict(c,store){
    const others=store.characters.filter(o=>o.id!==c.id&&o.location===c.location);
    if(!others.length)return null;
    const other=pick(others);
    if(!c.rivals.includes(other.id))c.rivals.push(other.id);
    if(!other.rivals.includes(c.id))other.rivals.push(c.id);
    c.reputation=Math.max(0,c.reputation-6);
    const reasons=['over an old grievance','when words turned bitter','about a matter of honour','over a stolen glance','when old wounds were opened'];
    return {text:`<span class="log-char">${c.name}</span> and <span class="log-char">${other.name}</span> clashed ${pick(reasons)}.`,type:'conflict'};
  },
  pursue_goal(c){
    if(!c.goal)return null;
    const acts=['quietly worked toward','made a small step toward','asked around about','brooded over','sought information about'];
    return {text:`<span class="log-char">${c.name}</span> ${pick(acts)}: ${c.goal.toLowerCase().slice(0,55)}${c.goal.length>55?'â€¦':''}`,type:'normal'};
  },
  ruminate(c){
    const thoughts=[
      `sat alone by the fire, haunted by thoughts of ${c.fear?c.fear.toLowerCase().slice(0,40):'the past'}.`,
      `wrote in a small journal and then hid it away.`,
      `stared at the horizon a long time. Said nothing.`,
      `hummed an old tune and felt briefly at peace.`,
      `turned an old memory over and over like a stone.`,
    ];
    if(c.voiceHabit&&Math.random()<0.3)
      return{text:`<span class="log-char">${c.name}</span> muttered: "${c.voiceHabit}"`,type:'normal'};
    return{text:`<span class="log-char">${c.name}</span> ${pick(thoughts)}`,type:'normal'};
  },
};

function pickAction(char){
  const pool=['rest','rest','ruminate','pursue_goal','pursue_goal'];
  if(char.energy>40)pool.push('wander','wander');
  if(char.social>60)pool.push('seek_bond','seek_bond');
  if(char.social<40)pool.push('ruminate','rest');
  const tl=char.traits.map(t=>t.toLowerCase());
  if(tl.includes('vengeful')||tl.includes('jealous'))pool.push('conflict');
  if(tl.includes('kind')||tl.includes('loyal'))pool.push('seek_bond');
  if(tl.includes('ambitious'))pool.push('pursue_goal','pursue_goal');
  if(tl.includes('reckless'))pool.push('conflict','wander');
  if(tl.includes('curious'))pool.push('wander','pursue_goal');
  if(char.archetype==='wanderer')pool.push('wander','wander');
  if(char.archetype==='lover')pool.push('seek_bond','seek_bond');
  if(char.archetype==='rebel')pool.push('conflict');
  if(char.archetype==='sage')pool.push('ruminate','ruminate');
  return pick(pool);
}

function tick(){
  STORE.hour+=2;
  if(STORE.hour>=24){STORE.hour=0;STORE.day++;}
  STORE.tick++;
  STORE.characters.forEach(char=>{
    if(Math.random()<0.45)return;
    const actionKey=pickAction(char);
    const actionFn=ACTION_POOL[actionKey];
    if(!actionFn)return;
    const result=actionFn(char,STORE);
    if(result){
      addLog(result.text,result.type);
      char.history.push(result.text.replace(/<[^>]+>/g,''));
      STORE.totalEvents++;
    }
    char.mood=pick(MOODS);
    char.energy=Math.max(0,char.energy-Math.random()*5);
  });
  updateWorldUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NUDGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nudge(type){
  const ev={
    rumour(){
      if(!STORE.characters.length)return;
      const c=pick(STORE.characters);
      const others=STORE.characters.filter(o=>o.id!==c.id);
      if(!others.length)return;
      const target=pick(others);
      addLog(`A dark rumour spreads: <span class="log-char">${c.name}</span> is said to have betrayed <span class="log-char">${target.name}</span>'s trust.`,'important');
      if(!c.rivals.includes(target.id))c.rivals.push(target.id);
    },
    storm(){
      addLog('A great storm descends. All souls take shelter.','important');
      STORE.characters.forEach(c=>{c.location=0;c.energy=Math.max(10,c.energy-25);});
    },
    stranger(){
      const names=['Edric Vane','Lena Shore','Thoros Gault','Mira Coldwell','Asha Wren','Brother Cael','Silas Rook'];
      const n=pick(names.filter(n=>!STORE.characters.find(c=>c.name===n)));
      if(!n)return;
      const sc=makeWorldChar({name:n,archetype:'outcast',archetypeGlyph:'â˜½',traits:[pick(ALL_TRAITS),pick(ALL_TRAITS)],goal:'Find a new beginning',fear:'Losing everything again',str:5,int:5,cha:5,res:5,lck:5,social:50,moral:50,temper:50,outlook:50,deception:40,relationships:[]});
      STORE.characters.push(sc);
      addLog(`A stranger named <span class="log-char">${n}</span> arrived at the settlement, eyes full of secrets.`,'important');
    },
    feast(){
      addLog('A grand feast is called. Spirits rise and old grudges soften.','important');
      STORE.characters.forEach(c=>{c.energy=Math.min(100,c.energy+35);c.mood='elated';});
    },
    plague(){
      addLog('A plague moves silently through the settlement.','important');
      STORE.characters.forEach(c=>{c.energy=Math.max(10,c.energy-35);c.mood=pick(['anxious','bitter','lonely']);});
    },
  };
  if(ev[type])ev[type]();
  STORE.totalEvents++;
  updateWorldUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORLD UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addLog(html,type='normal'){
  const container=document.getElementById('log-entries');
  if(!container)return;
  const el=document.createElement('div');
  el.className=`log-entry ${type}`;
  el.innerHTML=`<span class="log-time">Day ${STORE.day}, ${hourLabel(STORE.hour)}</span>${html}`;
  container.insertBefore(el,container.firstChild);
  while(container.children.length>80)container.removeChild(container.lastChild);
}

function renderRoster(){
  const list=document.getElementById('character-list');
  if(!list)return;
  list.innerHTML='';
  STORE.characters.forEach(char=>{
    const div=document.createElement('div');
    div.className='character-card'+(STORE.selectedId===char.id?' selected':'');
    div.onclick=()=>{STORE.selectedId=char.id;showCharDetail(char);renderRoster();drawWorld();};
    const col=getArchColor(char.archetype);
    div.innerHTML=`
      <div class="char-header">
        <div class="char-name"><span class="alive-dot"></span>${char.name}</div>
        <div class="char-status-badge" style="color:${col}">${char.archetype}</div>
      </div>
      <div class="char-trait-row">${(char.traits||[]).slice(0,4).map(t=>`<div class="trait-tag">${t}</div>`).join('')}</div>
      <div class="char-mood">${char.mood||'unknown'}</div>
    `;
    list.appendChild(div);
  });
}

function showCharDetail(char){
  const panel=document.getElementById('selected-detail');
  if(!panel)return;
  const bondNames=(char.bonds||[]).map(id=>STORE.characters.find(c=>c.id===id)?.name).filter(Boolean);
  const rivalNames=(char.rivals||[]).map(id=>STORE.characters.find(c=>c.id===id)?.name).filter(Boolean);
  const loc=LOCATIONS[char.location]?.name||'?';
  panel.innerHTML=`
    <div class="detail-name">${char.name}${char.alias?` <span style="font-size:11px;color:var(--muted);font-style:italic">"${char.alias}"</span>`:''}</div>
    <div class="stat-row">
      <div class="stat">Age <span class="stat-val">${char.age||'?'}</span></div>
      <div class="stat">Energy <span class="stat-val">${Math.round(char.energy||0)}%</span></div>
      <div class="stat">Rep <span class="stat-val">${Math.round(char.reputation||0)}</span></div>
      <div class="stat">At <span class="stat-val">${loc}</span></div>
    </div>
    ${char.occupation?`<div class="stat" style="margin-top:3px">Role: <span class="stat-val">${char.occupation}</span></div>`:''}
    ${char.goal?`<div class="stat" style="margin-top:3px">Goal: <span class="stat-val" style="font-style:italic">${char.goal.slice(0,60)}${char.goal.length>60?'â€¦':''}</span></div>`:''}
    ${char.fear?`<div class="stat">Fear: <span class="stat-val" style="font-style:italic">${char.fear.slice(0,50)}</span></div>`:''}
    ${bondNames.length?`<div class="stat" style="margin-top:3px">Bonds: <span class="stat-val">${bondNames.join(', ')}</span></div>`:''}
    ${rivalNames.length?`<div class="stat">Rivals: <span class="stat-val" style="color:var(--rust)">${rivalNames.join(', ')}</span></div>`:''}
  `;
}

function updateWorldUI(){
  const wt=document.getElementById('world-time');
  if(wt)wt.textContent=`Day ${STORE.day} â€” ${hourLabel(STORE.hour)}`;
  const sp=document.getElementById('stat-pop');if(sp)sp.textContent=STORE.characters.length;
  const sd=document.getElementById('stat-day');if(sd)sd.textContent=STORE.day;
  const se=document.getElementById('stat-events');if(se)se.textContent=STORE.totalEvents;
  const sb=document.getElementById('stat-bonds');if(sb)sb.textContent=STORE.totalBonds;
  renderRoster();
  if(STORE.selectedId){const c=STORE.characters.find(x=>x.id===STORE.selectedId);if(c)showCharDetail(c);}
  drawWorld();
}

function refreshLandingCast(){
  const wrap=document.getElementById('landing-cast');
  const chips=document.getElementById('cast-chips');
  if(!wrap||!chips)return;
  if(STORE.characters.length===0){wrap.style.display='none';return;}
  wrap.style.display='block';
  chips.innerHTML=STORE.characters.map(c=>`<div class="cast-chip" onclick="goTo('world')">${ARCHETYPE_MAP[c.archetype]?.glyph||'â—ˆ'} ${c.name}</div>`).join('');
}

// Sim loop
let simInterval=null;
const SPEEDS=[1,2,5];
let speedIdx=0;

function toggleRun(){
  STORE.running=!STORE.running;
  const btn=document.getElementById('run-btn');
  if(STORE.running){
    btn.textContent='â¸ Pause';btn.classList.add('active');
    simInterval=setInterval(()=>tick(),2000/STORE.speed);
  } else {
    btn.textContent='â–¶ Run';btn.classList.remove('active');
    clearInterval(simInterval);
  }
}
function cycleSpeed(){
  speedIdx=(speedIdx+1)%SPEEDS.length;
  STORE.speed=SPEEDS[speedIdx];
  document.getElementById('speed-btn').textContent=`Speed Ã—${STORE.speed}`;
  if(STORE.running){clearInterval(simInterval);simInterval=setInterval(()=>tick(),2000/STORE.speed);}
}

function initWorldIfNeeded(){
  if(STORE.worldInitialised)return;
  STORE.worldInitialised=true;
  setTimeout(()=>{resizeCanvas();drawWorld();},50);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pick(arr){return arr[Math.floor(Math.random()*arr.length)];}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderArchetypes();
renderTraitGrid();
</script>
</body>
</html>
